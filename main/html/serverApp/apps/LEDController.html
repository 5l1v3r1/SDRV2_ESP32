<!--h1>LED Controller</h1-->
<canvas id="app_LEDController_canvas" style="width: 100%; top: 0px; bottom: 0px;"></canvas>
<script type="text/javascript">
  $('[href="#LEDcontroller"]').on('click', function() {
    //load the whole page here
    //var canvas = document.getElementById('app_LEDController_canvas');
    //var ctx=canvas.getContext('2d');
    //ctx.fillStyle='#FF0000';
    //ctx.fillRect(0,0,80,100);
  });
  var appLEDcontrollerCanvas;
  var appLEDcontrollerCircle;
  var appLEDcontrollerShizhen;
  var appLEDcontrollerFenzhen;
  var appLEDcontrollerMiaozhen;
  var distance = 0;
  var nowRadius = 0;
  var targetRadius = 0;
  var closeRadius = 0;
  var openRadius = 0;
  var startTime = 0;
  var isOpen = false;
  function appLEDcontrollerRefresh50ms() {
    var width = $('#LEDcontroller').width();
    var height = $('#LEDcontroller').height();
    var armlen = Math.min(width, height) / 2;
    var canvas = appLEDcontrollerCanvas;
    var now = new Date();
    var deltaT = now.getTime() - startTime;
    distance = distance * Math.exp(-0.0005 * deltaT);
    nowRadius = targetRadius + distance * Math.cos(0.01 * deltaT);
    var circle = appLEDcontrollerCircle;
    circle.setRadius(nowRadius);
    circle.center();
    //console.log(canvas);
    function updateArm(arm, lengthScale, position) {
      arm.set({x2: width/2 + armlen * lengthScale * Math.sin(position * 2 * Math.PI),
        y2: height/2 - armlen * lengthScale * Math.cos(position * 2 * Math.PI)});
    }
    updateArm(appLEDcontrollerShizhen, 0.5, (now.getHours() % 12 + now.getMinutes() / 60) / 12);
    updateArm(appLEDcontrollerFenzhen, 0.8, (now.getMinutes() + now.getSeconds() / 60) / 60);
    updateArm(appLEDcontrollerMiaozhen, 0.9, now.getSeconds() / 60);
  }
  $(function() {
    var width = $('#LEDcontroller').width();
    var height = $('#LEDcontroller').height();
    nowRadius = Math.min(width, height) / 4.0;
    closeRadius = nowRadius;
    openRadius = closeRadius * 1.8;
    var now = new Date();
    startTime = now.getTime();
    appLEDcontrollerCanvas = new fabric.Canvas('app_LEDController_canvas', {
      backgroundColor: 'rgb(236,236,236)'
    });
    var canvas = appLEDcontrollerCanvas;
    canvas.setWidth(width);
    canvas.setHeight(height);
    appLEDcontrollerCircle = new fabric.Circle({
      fill : 'yellow',
      selectable: false,
    });
    var circle = appLEDcontrollerCircle;
    canvas.add(circle);
    circle.setRadius(100);
    circle.center();
    canvas.on('mouse:down', function() {
      //circle.setRadius(200);
      //circle.center();
    });
    canvas.on('mouse:up', function() {
      isOpen = !isOpen;
      targetRadius = closeRadius;
      if (isOpen) targetRadius = openRadius;
      distance = nowRadius - targetRadius;
      var now = new Date();
      startTime = now.getTime();
      //circle.setRadius(100);
      //circle.center();
      var cmd = "turnOffLight";
      if (isOpen) cmd = "turnOnLight";
      ESP32_GET(getCookie("esp32IP"), cmd, null, null);
    });
    appLEDcontrollerShizhen = new fabric.Line([width/2, height/2, width/2 + 100, height/2], {
      fill: 'red',
      stroke: 'red',
      strokeWidth: 5,
      selectable: false,
    });
    canvas.add(appLEDcontrollerShizhen);
    appLEDcontrollerFenzhen = new fabric.Line([width/2, height/2, width/2 + 100, height/2], {
      fill: 'blue',
      stroke: 'blue',
      strokeWidth: 3,
      selectable: false,
    });
    canvas.add(appLEDcontrollerFenzhen);
    appLEDcontrollerMiaozhen = new fabric.Line([width/2, height/2, width/2 + 100, height/2], {
      fill: 'green',
      stroke: 'green',
      strokeWidth: 1,
      selectable: false,
    });
    canvas.add(appLEDcontrollerMiaozhen);
    setInterval("appLEDcontrollerRefresh50ms()", 50);
  })
</script>
